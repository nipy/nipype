machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
    - "~/examples"

  pre:
    - mkdir -p "~/scratch/nose"
    # Let CircleCI cache the apt archive
    - sudo rm -rf /var/cache/apt/archives && sudo ln -s ~/.apt-cache /var/cache/apt/archives && mkdir -p ~/.apt-cache/partial

  override:
    - sudo apt-get -y update && sudo apt-get install -y wget bzip2
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
    - docker build -f docker/nipype_test_py27/Dockerfile -t nipype/nipype_test:py27 . :
        timeout: 1600
    - mkdir -p ~/docker; docker save nipype/nipype_test:py27 > ~/docker/image.tar :
        timeout: 1600
    - if [[ ! -d ~/examples/data ]]; then \
      wget -O nipype-tutorial.tar.bz2 https://googledrive.com/host/0BxI12kyv2olZR05SU1lPampNcVE && \
      tar jxvf nipype-tutorial.tar.bz2 && \
      mv nipype-tutorial/* ~/examples/; fi
    - if [[ ! -d ~/examples/feeds ]]; then \
      wget -O fsl-feeds.tar.gz https://googledrive.com/host/0BxI12kyv2olZNXBONlJKV0Y1Tm8 && \
      tar xzf fsl-feeds.tar.gz && \
      mv feeds ~/examples/; fi

test:
  override:
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/examples:/root/examples:ro -v $(pwd)/scratch:/scratch -w /scratch nipype/nipype_test:py27 /usr/bin/run_builddocs.sh
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/examples:/root/examples:ro -v $(pwd)/scratch:/scratch -w /scratch nipype/nipype_test:py27 /usr/bin/run_examples.sh test_spm Linear /root/examples/ workflow3d :
        timeout: 1600
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/examples:/root/examples:ro -v $(pwd)/scratch:/scratch -w /scratch nipype/nipype_test:py27 /usr/bin/run_examples.sh test_spm Linear /root/examples/ workflow4d :
        timeout: 1600
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/examples:/root/examples:ro -v $(pwd)/scratch:/scratch -w /scratch nipype/nipype_test:py27 /usr/bin/run_examples.sh fmri_fsl_feeds Linear /root/examples/ l1pipeline
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/examples:/root/examples:ro -v $(pwd)/scratch:/scratch -w /scratch nipype/nipype_test:py27 /usr/bin/run_examples.sh fmri_spm_dartel Linear /root/examples/ level1 :
        timeout: 1600
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/examples:/root/examples:ro -v $(pwd)/scratch:/scratch -w /scratch nipype/nipype_test:py27 /usr/bin/run_examples.sh fmri_spm_dartel Linear /root/examples/ l2pipeline :
        timeout: 1600
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/examples:/root/examples:ro -v $(pwd)/scratch:/scratch -w /scratch nipype/nipype_test:py27 /usr/bin/run_examples.sh fmri_fsl_reuse Linear /root/examples/ level1_workflow
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/examples:/root/examples:ro -v $(pwd)/scratch:/scratch -w /scratch nipype/nipype_test:py27 /usr/bin/run_examples.sh fmri_spm_nested Linear /root/examples/ level1
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/examples:/root/examples:ro -v $(pwd)/scratch:/scratch -w /scratch nipype/nipype_test:py27 /usr/bin/run_examples.sh fmri_spm_nested Linear /root/examples/ l2pipeline
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/examples:/root/examples:ro -v $(pwd)/scratch:/scratch -w /scratch nipype/nipype_test:py27 /usr/bin/run_nosetests.sh :
        timeout: 2600
  post:
    - bash docker/circleci/teardown.sh

general:
  artifacts:
    - "~/docs"
    - "~/logs"
    - "~/coverage.xml"
    - "~/nosetests.xml"
    - "~/builddocs.log"
    - "~/scratch"
