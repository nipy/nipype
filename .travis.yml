cache:
- apt
language: python
sudo: required

services:
  - docker

cache:
  directories:
    - $HOME/.cache/docker

python:
- 2.7
- 3.4
- 3.5

# env:
# - INSTALL_DEB_DEPENDECIES=true
# - INSTALL_DEB_DEPENDECIES=false

# Update docker to enable -f flag
before_install:
  - travis_retry sudo apt-get install -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" -y docker-engine
  - travis_retry pip install coveralls

install:
- mkdir -p $HOME/scratch
- mkdir -p $HOME/.cache/docker
- if [[ -e $HOME/.cache/docker/image${TRAVIS_PYTHON_VERSION//.}.tar ]]; then docker load -i $HOME/.cache/docker/image${TRAVIS_PYTHON_VERSION//.}.tar; fi
- travis_retry docker build -f docker/nipype_test_py${TRAVIS_PYTHON_VERSION//.}/Dockerfile -t nipype/nipype_test:py${TRAVIS_PYTHON_VERSION//.} .
- travis_retry docker save nipype/nipype_test:py${TRAVIS_PYTHON_VERSION//.} > $HOME/.cache/docker/image${TRAVIS_PYTHON_VERSION//.}.tar
script:
- docker run -v /etc/localtime:/etc/localtime:ro -v $HOME/scratch:/scratch -w /root/src/nipype nipype/nipype_test:py${TRAVIS_PYTHON_VERSION//.} nosetests --with-doctest --with-cov --cover-package nipype --cov-config /root/src/nipype/.coveragerc --logging-level=DEBUG --verbosity=3
after_success:
- coveralls --config_file .coveragerc
deploy:
  provider: pypi
  user: satra
  password:
    secure: OCO0FXb4f+pH4Uw7zWCIRp3qOJ1t7rhky4K8MjNU8tyVCJgd6O/Bv8GJgceS0LktPodlAAjB8SxAhTORPAQZ1D/44PJYy3NQIisvej1zjLpaA9TEGfl6W7MqhDpRyMHW+cnSi/n84SAmdr+Z4vOxScDHdwr13EPmGyOIlHMAGnE=
  on:
    tags: true
    repo: nipy/nipype
    branch: master
  distributions: "sdist"
