cache:
- apt
language: python
sudo: required

services:
  - docker

cache:
  directories:
    - $HOME/.cache/docker

python:
- 2.7
- 3.4
- 3.5

# env:
# - INSTALL_DEB_DEPENDECIES=true
# - INSTALL_DEB_DEPENDECIES=false

# Update docker to enable -f flag
before_install:  
  - sudo apt-get -y update && sudo apt-get install -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" -y docker-engine

install:
- mkdir -p $HOME/scratch
- if [[ -e $HOME/.cache/docker/image${TRAVIS_PYTHON_VERSION//.}.tar ]]; then docker load -i $HOME/.cache/docker/image${TRAVIS_PYTHON_VERSION//.}.tar; fi
- docker build -f docker/nipype_test_py${TRAVIS_PYTHON_VERSION//.}/Dockerfile -t nipype/nipype_test:py${TRAVIS_PYTHON_VERSION//.} .
script:
- docker run -i -v /etc/localtime:/etc/localtime:ro -v $HOME/scratch:/scratch -w /scratch /usr/bin/run_travis_tests.sh nipype/nipype_test:py${TRAVIS_PYTHON_VERSION//.}
after_success:
- coveralls --config_file .coveragerc
- mkdir -p $HOME/.cache/docker; docker save nipype/nipype_test:py${TRAVIS_PYTHON_VERSION} > $HOME/.cache/docker/image${TRAVIS_PYTHON_VERSION//.}.tar
deploy:
  provider: pypi
  user: satra
  password:
    secure: OCO0FXb4f+pH4Uw7zWCIRp3qOJ1t7rhky4K8MjNU8tyVCJgd6O/Bv8GJgceS0LktPodlAAjB8SxAhTORPAQZ1D/44PJYy3NQIisvej1zjLpaA9TEGfl6W7MqhDpRyMHW+cnSi/n84SAmdr+Z4vOxScDHdwr13EPmGyOIlHMAGnE=
  on:
    tags: true
    repo: nipy/nipype
    branch: master
  distributions: "sdist"
