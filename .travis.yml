cache:
- apt
language: python
sudo: required

services:
  - docker

cache:
  directories:
    - $HOME/.cache/docker

python:
- 2.7
- 3.4
- 3.5

env:
- INSTALL_DEB_DEPENDECIES="nodeps"
# - INSTALL_DEB_DEPENDECIES=false

# Update docker to enable -f flag
before_install:
  - travis_retry sudo apt-get install -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" -y docker-engine
  - travis_retry pip install coveralls

install:
- mkdir -p $HOME/scratch
- mkdir -p $HOME/.cache/docker
- if [[ -e $HOME/.cache/docker/image${TRAVIS_PYTHON_VERSION//.}.tar ]]; then docker load -i $HOME/.cache/docker/image${TRAVIS_PYTHON_VERSION//.}.tar; fi
- docker pull nipype/nipype_test:${INSTALL_DEB_DEPENDECIES}-base${TRAVIS_PYTHON_VERSION//.}
- travis_wait 30 docker save nipype/nipype_test:${INSTALL_DEB_DEPENDECIES}-base${TRAVIS_PYTHON_VERSION//.} -o $HOME/.cache/docker/image${TRAVIS_PYTHON_VERSION//.}.tar
- docker build -f docker/nipype_test_${INSTALL_DEB_DEPENDECIES}/Dockerfile_py${TRAVIS_PYTHON_VERSION//.} -t nipype/nipype_test:${INSTALL_DEB_DEPENDECIES}-py${TRAVIS_PYTHON_VERSION//.} .

script:
- docker run -v /etc/localtime:/etc/localtime:ro -v $HOME/scratch:/scratch nipype/nipype_test:${INSTALL_DEB_DEPENDECIES}-py${TRAVIS_PYTHON_VERSION//.} nosetests -c /root/src/nipype/.noserc --cov-report xml --with-cov --processes=0 --cover-package nipype --cov-config /root/src/nipype/.coveragerc /root/src/nipype/
after_success:
- coveralls --config_file ~/scratch/.coveragerc
deploy:
  provider: pypi
  user: satra
  password:
    secure: OCO0FXb4f+pH4Uw7zWCIRp3qOJ1t7rhky4K8MjNU8tyVCJgd6O/Bv8GJgceS0LktPodlAAjB8SxAhTORPAQZ1D/44PJYy3NQIisvej1zjLpaA9TEGfl6W7MqhDpRyMHW+cnSi/n84SAmdr+Z4vOxScDHdwr13EPmGyOIlHMAGnE=
  on:
    tags: true
    repo: nipy/nipype
    branch: master
  distributions: "sdist"
