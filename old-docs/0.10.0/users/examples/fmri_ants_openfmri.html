<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Neuroimaging in Python - Pipelines and Interfaces &mdash; nipy pipeline and interfaces package</title>
    
    <link rel="stylesheet" href="../../_static/nipype.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.10.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="top" title="nipy pipeline and interfaces package" href="../../index.html" />
 
<meta name="keywords" content="nipype, neuroimaging, pipeline, workflow, parallel, python, neuroscience">
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-339450-7', 'nipy.org/nipype');
  ga('send', 'pageview');
</script>

  </head>
  <body role="document">
<div class="header-wrapper">
    <div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
            <a href="../../index.html">
            <img src="../../_static/nipype-banner-bg.png" alt="NIPY logo"  border="0" />
        <div style="margin-top: 1em;
                border-top: 1px solid #AAA;
                border-bottom: 1px solid #AAA;
                border-radius: 5px;
                padding: 3px 1em;">
            <link rel="stylesheet" href="http://www.google.com/cse/style/look/default.css" type="text/css" />
<style type="text/css">
    a.navbar {
    color: ;
    letter-spacing: .05em;
    font-weight: bold;
        }
</style>

<a class="navbar" href="../../index.html">Home</a> ·
<a class="navbar" href="../../quickstart.html">Quickstart</a> ·
<a class="navbar" href="../../documentation.html">Documentation</a> ·
<a class="navbar" href="../../about.html">Citation</a> ·
<a class="navbar" href="http://nipy.org">NiPy</a>

        </div>
    </div>
</div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<style type="text/css">
    input.gsc-input {
        border-color: #BCCDF0;
    }
    input.gsc-search-button {
        border-color: #666666;
        background-color: #CECECE;
        padding: 0;
    }
    div.sphinxsidebar .tile {
        border: 1px solid #D1DDE2;
        border-radius: 10px;
        background-color: #E1E8EC;
        padding-left: 0.5em;
        margin: 1em 0;
    }
    div.sphinxsidebar input[type="text"] {
        width: 100%;
    }
    div.sphinxsidebar input[type="submit"] {
        width: 100%;
    }
</style>

<div class="sidebarblock">
    <div id="cse-search-form">Loading</div>

    <script src="http://www.google.com/jsapi" type="text/javascript"></script>
    <script type="text/javascript">
        google.load('search', '1', {language : 'en'});
        google.setOnLoadCallback(function() {
            var customSearchControl = new google.search.CustomSearchControl(
                    '010960497803984932957:u8pmqf7fdoq');

            customSearchControl.setResultSetSize(google.search.Search.FILTERED_CSE_RESULTSET);
            var options = new google.search.DrawOptions();
            options.enableSearchboxOnly("../../searchresults.html");
            customSearchControl.draw('cse-search-form', options);
        }, true);
    </script>
</div>

<style type="text/css">
    div.sphinxsidebar .tile {
        border: 1px solid #D1DDE2;
        border-radius: 10px;
        background-color: #E1E8EC;
        padding-left: 0.5em;
        margin: 1em 0;
    }
</style>
<div class="sidebarblock">
    <h3>Versions</h3>

    <div class="tile">
        <table style="width: 100%;">
            <tr style="font-weight: bold;">
                <td align="left">Release</td><td align="right">Devel</td>
            </tr>
            <tr>
                <td align="left">0.10.0</td><td align="right">1.0-dev</td>
            </tr>
            <tr>
                <td align="left"><a href="../install.html">Download</a></td>
                <td align="right"><a href="https://github.com/nipy/nipype">Github</a></td>
            </tr>
        </table>
    </div>

    <div id="buttons">
        <div id="ohloh-use" style="margin-right: 25px; margin-top: -2px; float: left;">
            <script type="text/javascript"
                    src="http://www.ohloh.net/p/480871/widgets/project_users_logo.js">
            </script>
        </div><!-- use -->
        <g:plusone size="medium" annotation="none"></g:plusone>
        <div class="clear"></div>
    </div><!-- buttons container -->
</div>


<script type="text/javascript">
    (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
</script>

<h3>Links</h3>

<ul>
    <li>Docs: <a href="http://nipy.org/nipype">Stable</a> · <a href="http://www.mit.edu/~satra/nipype-nightly/">Nightly</a></li>
    <li>Code: <a href="http://github.com/nipy/nipype">Github</a> · <a href="http://github.com/nipy/nipype/issues">Bugs-Requests</a></li>
    <li>Forum: <a href="http://neurostars.org/t/nipype">User</a> · <a href="http://projects.scipy.org/mailman/listinfo/nipy-devel">Developer</a></li>
    <li><a href="http://nipy.org/software/license/index.html"><img src="https://pypip.in/license/nipype/badge.png" alt="License"></a> · <a href="http://nipy.org/about/funding.html">Funding</a></li>
    <li><a href="https://travis-ci.org/nipy/nipype"><img src="https://travis-ci.org/nipy/nipype.png?branch=master" alt="travis"></a> · <a href='https://coveralls.io/r/nipy/nipype'><img src='https://coveralls.io/repos/nipy/nipype/badge.png' alt='Coverage Status' /></a></li>
    <li><a href="https://pypi.python.org/pypi/nipype/"><img src="https://pypip.in/download/nipype/badge.png" alt="Downloads"></a> · <a href='https://pypi.python.org/pypi/nipype/'><img src='https://pypip.in/py_versions/nipype/badge.png' alt='Python Versions' /></a></li>
</ul>


        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="fmri-openfmri-org-data-fsl-ants-c3daffine">
<span id="example-fmri-ants-openfmri"></span><h1>fMRI: OpenfMRI.org data, FSL, ANTS, c3daffine<a class="headerlink" href="#fmri-openfmri-org-data-fsl-ants-c3daffine" title="Permalink to this headline">¶</a></h1>
<p>A growing number of datasets are available on <a class="reference external" href="http://openfmri.org">OpenfMRI</a>.
This script demonstrates how to use nipype to analyze a data set.</p>
<blockquote>
<div>python fmri_ants_openfmri.py &#8211;datasetdir ds107</div></blockquote>
<div class="highlight-python"><div class="highlight"><pre>from nipype import config
config.enable_provenance()
from nipype.external import six


from glob import glob
import os

import nipype.pipeline.engine as pe
import nipype.algorithms.modelgen as model
import nipype.algorithms.rapidart as ra
import nipype.interfaces.fsl as fsl
import nipype.interfaces.ants as ants
from nipype.interfaces.c3 import C3dAffineTool
import nipype.interfaces.io as nio
import nipype.interfaces.utility as niu
from nipype.workflows.fmri.fsl import (create_featreg_preproc,
                                       create_modelfit_workflow,
                                       create_fixed_effects_flow)

from nipype import LooseVersion

version = 0
if fsl.Info.version() and \
    LooseVersion(fsl.Info.version()) &gt; LooseVersion(&#39;5.0.6&#39;):
    version = 507

fsl.FSLCommand.set_default_output_type(&#39;NIFTI_GZ&#39;)


def create_reg_workflow(name=&#39;registration&#39;):
    &quot;&quot;&quot;Create a FEAT preprocessing workflow together with freesurfer

    Parameters
    ----------

    ::

        name : name of workflow (default: &#39;registration&#39;)

    Inputs::

        inputspec.source_files : files (filename or list of filenames to register)
        inputspec.mean_image : reference image to use
        inputspec.anatomical_image : anatomical image to coregister to
        inputspec.target_image : registration target

    Outputs::

        outputspec.func2anat_transform : FLIRT transform
        outputspec.anat2target_transform : FLIRT+FNIRT transform
        outputspec.transformed_files : transformed files in target space
        outputspec.transformed_mean : mean image in target space

    Example
    -------
</pre></div>
</div>
<p>register = pe.Workflow(name=name)
inputnode = pe.Node(interface=niu.IdentityInterface(fields=[&#8216;source_files&#8217;,</p>
<blockquote>
<div><blockquote>
<div>&#8216;mean_image&#8217;,
&#8216;anatomical_image&#8217;,
&#8216;target_image&#8217;,
&#8216;target_image_brain&#8217;,
&#8216;config_file&#8217;]),</div></blockquote>
<p>name=&#8217;inputspec&#8217;)</p>
</div></blockquote>
<dl class="docutils">
<dt>outputnode = pe.Node(interface=niu.IdentityInterface(fields=[&#8216;func2anat_transform&#8217;,</dt>
<dd><blockquote class="first">
<div>&#8216;anat2target_transform&#8217;,
&#8216;transformed_files&#8217;,
&#8216;transformed_mean&#8217;,
]),</div></blockquote>
<p class="last">name=&#8217;outputspec&#8217;)</p>
</dd>
</dl>
<dl class="docutils">
<dt>::</dt>
<dd><p class="first">Estimate the tissue classes from the anatomical image. But use spm&#8217;s segment
as FSL appears to be breaking.
&#8220;&#8221;&#8220;</p>
<p class="last">stripper = pe.Node(fsl.BET(), name=&#8217;stripper&#8217;)
register.connect(inputnode, &#8216;anatomical_image&#8217;, stripper, &#8216;in_file&#8217;)
fast = pe.Node(fsl.FAST(), name=&#8217;fast&#8217;)
register.connect(stripper, &#8216;out_file&#8217;, fast, &#8216;in_files&#8217;)</p>
</dd>
</dl>
<p>Binarize the segmentation</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">binarize</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">ImageMaths</span><span class="p">(</span><span class="n">op_string</span><span class="o">=</span><span class="s">&#39;-nan -thr 0.5 -bin&#39;</span><span class="p">),</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&#39;binarize&#39;</span><span class="p">)</span>
<span class="n">pickindex</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">fast</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;partial_volume_files&#39;</span><span class="p">,</span> <span class="n">pickindex</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                 <span class="n">binarize</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Calculate rigid transform from mean image to anatomical image</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mean2anat</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;mean2anat&#39;</span><span class="p">)</span>
<span class="n">mean2anat</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s">&#39;mean_image&#39;</span><span class="p">,</span> <span class="n">mean2anat</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">stripper</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">mean2anat</span><span class="p">,</span> <span class="s">&#39;reference&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now use bbr cost function to improve the transform</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mean2anatbbr</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;mean2anatbbr&#39;</span><span class="p">)</span>
<span class="n">mean2anatbbr</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">mean2anatbbr</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">cost</span> <span class="o">=</span> <span class="s">&#39;bbr&#39;</span>
<span class="n">mean2anatbbr</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;FSLDIR&#39;</span><span class="p">),</span>
                                            <span class="s">&#39;etc/flirtsch/bbr.sch&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s">&#39;mean_image&#39;</span><span class="p">,</span> <span class="n">mean2anatbbr</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">binarize</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">mean2anatbbr</span><span class="p">,</span> <span class="s">&#39;wm_seg&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s">&#39;anatomical_image&#39;</span><span class="p">,</span> <span class="n">mean2anatbbr</span><span class="p">,</span> <span class="s">&#39;reference&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mean2anat</span><span class="p">,</span> <span class="s">&#39;out_matrix_file&#39;</span><span class="p">,</span>
                 <span class="n">mean2anatbbr</span><span class="p">,</span> <span class="s">&#39;in_matrix_file&#39;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Convert the BBRegister transformation to ANTS ITK format</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">convert2itk</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">C3dAffineTool</span><span class="p">(),</span>
                      <span class="n">name</span><span class="o">=</span><span class="s">&#39;convert2itk&#39;</span><span class="p">)</span>
<span class="n">convert2itk</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fsl2ras</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">convert2itk</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">itk_transform</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mean2anatbbr</span><span class="p">,</span> <span class="s">&#39;out_matrix_file&#39;</span><span class="p">,</span> <span class="n">convert2itk</span><span class="p">,</span> <span class="s">&#39;transform_file&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s">&#39;mean_image&#39;</span><span class="p">,</span><span class="n">convert2itk</span><span class="p">,</span> <span class="s">&#39;source_file&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">stripper</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">convert2itk</span><span class="p">,</span> <span class="s">&#39;reference_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Compute registration between the subject&#8217;s structural and MNI template
This is currently set to perform a very quick registration. However, the
registration can be made significantly more accurate for cortical
structures by increasing the number of iterations
All parameters are set using the example from:
#https://github.com/stnava/ANTs/blob/master/Scripts/newAntsExample.sh</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">reg</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">ants</span><span class="o">.</span><span class="n">Registration</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;antsRegister&#39;</span><span class="p">)</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_transform_prefix</span> <span class="o">=</span> <span class="s">&quot;output_&quot;</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Rigid&#39;</span><span class="p">,</span> <span class="s">&#39;Affine&#39;</span><span class="p">,</span> <span class="s">&#39;SyN&#39;</span><span class="p">]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">transform_parameters</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.1</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)]</span>
<span class="c">#reg.inputs.number_of_iterations = ([[10000, 111110, 11110]] * 2 + [[100, 50, 30]])</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">number_of_iterations</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">11110</span><span class="p">,</span> <span class="mi">11110</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">20</span><span class="p">]]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">write_composite_transform</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">collapse_output_transforms</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">initial_moving_transform_com</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Mattes&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[[</span><span class="s">&#39;Mattes&#39;</span><span class="p">,</span> <span class="s">&#39;CC&#39;</span><span class="p">]]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metric_weight</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">radius_or_number_of_bins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sampling_strategy</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Regular&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sampling_percentage</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">convergence_threshold</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.e-8</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">convergence_window_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">smoothing_sigmas</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sigma_units</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;vox&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">shrink_factors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">use_estimate_learning_rate_once</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">use_histogram_matching</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">winsorize_lower_quantile</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">winsorize_upper_quantile</span> <span class="o">=</span> <span class="mf">0.995</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s">&#39;--float&#39;</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_warped_image</span> <span class="o">=</span> <span class="s">&#39;output_warped_image.nii.gz&#39;</span>
<span class="n">reg</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">num_threads</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">reg</span><span class="o">.</span><span class="n">plugin_args</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;qsub_args&#39;</span><span class="p">:</span> <span class="s">&#39;-l nodes=1:ppn=4&#39;</span><span class="p">}</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">stripper</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="s">&#39;moving_image&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span><span class="s">&#39;target_image_brain&#39;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span><span class="s">&#39;fixed_image&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Concatenate the affine and ants transforms into a list</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pickfirst</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">merge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in2&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;mergexfm&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">convert2itk</span><span class="p">,</span> <span class="s">&#39;itk_transform&#39;</span><span class="p">,</span> <span class="n">merge</span><span class="p">,</span> <span class="s">&#39;in2&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;composite_transform&#39;</span><span class="p">,</span> <span class="n">pickfirst</span><span class="p">),</span> <span class="n">merge</span><span class="p">,</span> <span class="s">&#39;in1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Transform the mean image. First to anatomical and then to target</p>
<dl class="docutils">
<dt>::</dt>
<dd><dl class="first docutils">
<dt>warpmean = pe.Node(ants.ApplyTransforms(),</dt>
<dd>name=&#8217;warpmean&#8217;)</dd>
</dl>
<p>warpmean.inputs.input_image_type = 3
warpmean.inputs.interpolation = &#8216;BSpline&#8217;
warpmean.inputs.invert_transform_flags = [False, False]
warpmean.inputs.terminal_output = &#8216;file&#8217;</p>
<p class="last">register.connect(inputnode,&#8217;target_image_brain&#8217;, warpmean,&#8217;reference_image&#8217;)
register.connect(inputnode, &#8216;mean_image&#8217;, warpmean, &#8216;input_image&#8217;)
register.connect(merge, &#8216;out&#8217;, warpmean, &#8216;transforms&#8217;)</p>
</dd>
</dl>
<p>Transform the remaining images. First to anatomical and then to target</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">warpall</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">ants</span><span class="o">.</span><span class="n">ApplyTransforms</span><span class="p">(),</span>
                     <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;input_image&#39;</span><span class="p">],</span>
                     <span class="n">name</span><span class="o">=</span><span class="s">&#39;warpall&#39;</span><span class="p">)</span>
<span class="n">warpall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">input_image_type</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">warpall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="s">&#39;BSpline&#39;</span>
<span class="n">warpall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">invert_transform_flags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span>
<span class="n">warpall</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">terminal_output</span> <span class="o">=</span> <span class="s">&#39;file&#39;</span>

<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span><span class="s">&#39;target_image_brain&#39;</span><span class="p">,</span><span class="n">warpall</span><span class="p">,</span><span class="s">&#39;reference_image&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span><span class="s">&#39;source_files&#39;</span><span class="p">,</span> <span class="n">warpall</span><span class="p">,</span> <span class="s">&#39;input_image&#39;</span><span class="p">)</span>
<span class="n">register</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">merge</span><span class="p">,</span> <span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="n">warpall</span><span class="p">,</span> <span class="s">&#39;transforms&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Assign all the output files</p>
<div class="highlight-python"><div class="highlight"><pre>    register.connect(warpmean, &#39;output_image&#39;, outputnode, &#39;transformed_mean&#39;)
    register.connect(warpall, &#39;output_image&#39;, outputnode, &#39;transformed_files&#39;)
    register.connect(mean2anatbbr, &#39;out_matrix_file&#39;,
                     outputnode, &#39;func2anat_transform&#39;)
    register.connect(reg, &#39;composite_transform&#39;,
                     outputnode, &#39;anat2target_transform&#39;)

    return register

def get_subjectinfo(subject_id, base_dir, task_id, model_id):
    &quot;&quot;&quot;Get info for a given subject

    Parameters
    ----------
    subject_id : string
        Subject identifier (e.g., sub001)
    base_dir : string
        Path to base directory of the dataset
    task_id : int
        Which task to process
    model_id : int
        Which model to process

    Returns
    -------
    run_ids : list of ints
        Run numbers
    conds : list of str
        Condition names
    TR : float
        Repetition time
    &quot;&quot;&quot;
    from glob import glob
    import os
    import numpy as np
    condition_info = []
    cond_file = os.path.join(base_dir, &#39;models&#39;, &#39;model%03d&#39; % model_id,
                             &#39;condition_key.txt&#39;)
    with open(cond_file, &#39;rt&#39;) as fp:
        for line in fp:
            info = line.strip().split()
            condition_info.append([info[0], info[1], &#39; &#39;.join(info[2:])])
    if len(condition_info) == 0:
        raise ValueError(&#39;No condition info found in %s&#39; % cond_file)
    taskinfo = np.array(condition_info)
    n_tasks = len(np.unique(taskinfo[:, 0]))
    conds = []
    run_ids = []
    if task_id &gt; n_tasks:
        raise ValueError(&#39;Task id %d does not exist&#39; % task_id)
    for idx in range(n_tasks):
        taskidx = np.where(taskinfo[:, 0] == &#39;task%03d&#39; % (idx + 1))
        conds.append([condition.replace(&#39; &#39;, &#39;_&#39;) for condition
                      in taskinfo[taskidx[0], 2]])
        files = glob(os.path.join(base_dir,
                                  subject_id,
                                  &#39;BOLD&#39;,
                                  &#39;task%03d_run*&#39; % (idx + 1)))
        run_ids.insert(idx, range(1, len(files) + 1))
    TR = np.genfromtxt(os.path.join(base_dir, &#39;scan_key.txt&#39;))[1]
    return run_ids[task_id - 1], conds[task_id - 1], TR


def analyze_openfmri_dataset(data_dir, subject=None, model_id=None,
                             task_id=None, output_dir=None, subj_prefix=&#39;*&#39;,
                             hpcutoff=120., use_derivatives=True,
                             fwhm=6.0):
    &quot;&quot;&quot;Analyzes an open fmri dataset

    Parameters
    ----------

    data_dir : str
        Path to the base data directory

    work_dir : str
        Nipype working directory (defaults to cwd)
    &quot;&quot;&quot;
</pre></div>
</div>
<p>Load nipype workflows</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">preproc</span> <span class="o">=</span> <span class="n">create_featreg_preproc</span><span class="p">(</span><span class="n">whichvol</span><span class="o">=</span><span class="s">&#39;first&#39;</span><span class="p">)</span>
<span class="n">modelfit</span> <span class="o">=</span> <span class="n">create_modelfit_workflow</span><span class="p">()</span>
<span class="n">fixed_fx</span> <span class="o">=</span> <span class="n">create_fixed_effects_flow</span><span class="p">()</span>
<span class="n">registration</span> <span class="o">=</span> <span class="n">create_reg_workflow</span><span class="p">()</span>
</pre></div>
</div>
<p>Remove the plotting connection so that plot iterables don&#8217;t propagate
to the model stage</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">preproc</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">preproc</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s">&#39;plot_motion&#39;</span><span class="p">),</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                   <span class="n">preproc</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s">&#39;outputspec&#39;</span><span class="p">),</span> <span class="s">&#39;motion_plots&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Set up openfmri data specific components</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span>
                   <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">subj_prefix</span><span class="p">))])</span>

<span class="n">infosource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span>
                                                   <span class="s">&#39;model_id&#39;</span><span class="p">,</span>
                                                   <span class="s">&#39;task_id&#39;</span><span class="p">]),</span>
                     <span class="n">name</span><span class="o">=</span><span class="s">&#39;infosource&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subjects</span><span class="p">),</span>
                            <span class="p">(</span><span class="s">&#39;model_id&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">model_id</span><span class="p">]),</span>
                            <span class="p">(</span><span class="s">&#39;task_id&#39;</span><span class="p">,</span> <span class="n">task_id</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span>
                             <span class="p">[</span><span class="n">subjects</span><span class="p">[</span><span class="n">subjects</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">subj</span><span class="p">)]</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">]),</span>
                            <span class="p">(</span><span class="s">&#39;model_id&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">model_id</span><span class="p">]),</span>
                            <span class="p">(</span><span class="s">&#39;task_id&#39;</span><span class="p">,</span> <span class="n">task_id</span><span class="p">)]</span>

<span class="n">subjinfo</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s">&#39;base_dir&#39;</span><span class="p">,</span>
                                             <span class="s">&#39;task_id&#39;</span><span class="p">,</span> <span class="s">&#39;model_id&#39;</span><span class="p">],</span>
                                <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;run_id&#39;</span><span class="p">,</span> <span class="s">&#39;conds&#39;</span><span class="p">,</span> <span class="s">&#39;TR&#39;</span><span class="p">],</span>
                                <span class="n">function</span><span class="o">=</span><span class="n">get_subjectinfo</span><span class="p">),</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&#39;subjectinfo&#39;</span><span class="p">)</span>
<span class="n">subjinfo</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
</pre></div>
</div>
<p>Return data components as anat, bold and behav</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">datasource</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">nio</span><span class="o">.</span><span class="n">DataGrabber</span><span class="p">(</span><span class="n">infields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s">&#39;run_id&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;task_id&#39;</span><span class="p">,</span> <span class="s">&#39;model_id&#39;</span><span class="p">],</span>
                                     <span class="n">outfields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;anat&#39;</span><span class="p">,</span> <span class="s">&#39;bold&#39;</span><span class="p">,</span> <span class="s">&#39;behav&#39;</span><span class="p">,</span>
                                                <span class="s">&#39;contrasts&#39;</span><span class="p">]),</span>
                     <span class="n">name</span><span class="o">=</span><span class="s">&#39;datasource&#39;</span><span class="p">)</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">base_directory</span> <span class="o">=</span> <span class="n">data_dir</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">field_template</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;anat&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/anatomy/highres001.nii.gz&#39;</span><span class="p">,</span>
                            <span class="s">&#39;bold&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/BOLD/task</span><span class="si">%03d</span><span class="s">_r*/bold.nii.gz&#39;</span><span class="p">,</span>
                            <span class="s">&#39;behav&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/model/model</span><span class="si">%03d</span><span class="s">/onsets/task</span><span class="si">%03d</span><span class="s">_&#39;</span>
                                      <span class="s">&#39;run</span><span class="si">%03d</span><span class="s">/cond*.txt&#39;</span><span class="p">),</span>
                            <span class="s">&#39;contrasts&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;models/model</span><span class="si">%03d</span><span class="s">/&#39;</span>
                                          <span class="s">&#39;task_contrasts.txt&#39;</span><span class="p">)}</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">template_args</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;anat&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s">&#39;subject_id&#39;</span><span class="p">]],</span>
                                   <span class="s">&#39;bold&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s">&#39;task_id&#39;</span><span class="p">]],</span>
                                   <span class="s">&#39;behav&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s">&#39;model_id&#39;</span><span class="p">,</span>
                                              <span class="s">&#39;task_id&#39;</span><span class="p">,</span> <span class="s">&#39;run_id&#39;</span><span class="p">]],</span>
                                   <span class="s">&#39;contrasts&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s">&#39;model_id&#39;</span><span class="p">]]}</span>
<span class="n">datasource</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">sort_filelist</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>Create meta workflow</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">wf</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;openfmri&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subjinfo</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;model_id&#39;</span><span class="p">,</span> <span class="n">subjinfo</span><span class="p">,</span> <span class="s">&#39;model_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;task_id&#39;</span><span class="p">,</span> <span class="n">subjinfo</span><span class="p">,</span> <span class="s">&#39;task_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;model_id&#39;</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="s">&#39;model_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;task_id&#39;</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="s">&#39;task_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">&#39;run_id&#39;</span><span class="p">,</span> <span class="n">datasource</span><span class="p">,</span> <span class="s">&#39;run_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">preproc</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;bold&#39;</span><span class="p">,</span> <span class="s">&#39;inputspec.func&#39;</span><span class="p">)]),</span>
            <span class="p">])</span>

<span class="k">def</span> <span class="nf">get_highpass</span><span class="p">(</span><span class="n">TR</span><span class="p">,</span> <span class="n">hpcutoff</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">hpcutoff</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">TR</span><span class="p">)</span>
<span class="n">gethighpass</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;TR&#39;</span><span class="p">,</span> <span class="s">&#39;hpcutoff&#39;</span><span class="p">],</span>
                                   <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;highpass&#39;</span><span class="p">],</span>
                                   <span class="n">function</span><span class="o">=</span><span class="n">get_highpass</span><span class="p">),</span>
                      <span class="n">name</span><span class="o">=</span><span class="s">&#39;gethighpass&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">&#39;TR&#39;</span><span class="p">,</span> <span class="n">gethighpass</span><span class="p">,</span> <span class="s">&#39;TR&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">gethighpass</span><span class="p">,</span> <span class="s">&#39;highpass&#39;</span><span class="p">,</span> <span class="n">preproc</span><span class="p">,</span> <span class="s">&#39;inputspec.highpass&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Setup a basic set of contrasts, a t-test per condition</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_contrasts</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">conds</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="n">contrast_def</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrast_def</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">contrast_def</span> <span class="o">=</span> <span class="n">contrast_def</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">contrasts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">contrast_def</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;task</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">task_id</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">con</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;cond</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conds</span><span class="p">))],</span>
               <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="n">contrasts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
    <span class="c"># add auto contrasts for each column</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cond</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conds</span><span class="p">):</span>
        <span class="n">con</span> <span class="o">=</span> <span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;cond</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">contrasts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">contrasts</span>

<span class="n">contrastgen</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;contrast_file&#39;</span><span class="p">,</span>
                                                <span class="s">&#39;task_id&#39;</span><span class="p">,</span> <span class="s">&#39;conds&#39;</span><span class="p">],</span>
                                   <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;contrasts&#39;</span><span class="p">],</span>
                                   <span class="n">function</span><span class="o">=</span><span class="n">get_contrasts</span><span class="p">),</span>
                      <span class="n">name</span><span class="o">=</span><span class="s">&#39;contrastgen&#39;</span><span class="p">)</span>

<span class="n">art</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">MapNode</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">ra</span><span class="o">.</span><span class="n">ArtifactDetect</span><span class="p">(</span><span class="n">use_differences</span><span class="o">=</span><span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">],</span>
                                             <span class="n">use_norm</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                             <span class="n">norm_threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">zintensity_threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                             <span class="n">parameter_source</span><span class="o">=</span><span class="s">&#39;FSL&#39;</span><span class="p">,</span>
                                             <span class="n">mask_type</span><span class="o">=</span><span class="s">&#39;file&#39;</span><span class="p">),</span>
                 <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;realigned_files&#39;</span><span class="p">,</span> <span class="s">&#39;realignment_parameters&#39;</span><span class="p">,</span>
                            <span class="s">&#39;mask_file&#39;</span><span class="p">],</span>
                 <span class="n">name</span><span class="o">=</span><span class="s">&quot;art&quot;</span><span class="p">)</span>

<span class="n">modelspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">SpecifyModel</span><span class="p">(),</span>
                       <span class="n">name</span><span class="o">=</span><span class="s">&quot;modelspec&quot;</span><span class="p">)</span>
<span class="n">modelspec</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">input_units</span> <span class="o">=</span> <span class="s">&#39;secs&#39;</span>

<span class="k">def</span> <span class="nf">check_behav_list</span><span class="p">(</span><span class="n">behav</span><span class="p">):</span>
    <span class="n">out_behav</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">behav</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">behav</span> <span class="o">=</span> <span class="p">[</span><span class="n">behav</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">behav</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">out_behav</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">val</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_behav</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_behav</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">&#39;TR&#39;</span><span class="p">,</span> <span class="n">modelspec</span><span class="p">,</span> <span class="s">&#39;time_repetition&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;behav&#39;</span><span class="p">,</span> <span class="n">check_behav_list</span><span class="p">),</span> <span class="n">modelspec</span><span class="p">,</span> <span class="s">&#39;event_files&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">&#39;TR&#39;</span><span class="p">,</span> <span class="n">modelfit</span><span class="p">,</span> <span class="s">&#39;inputspec.interscan_interval&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subjinfo</span><span class="p">,</span> <span class="s">&#39;conds&#39;</span><span class="p">,</span> <span class="n">contrastgen</span><span class="p">,</span> <span class="s">&#39;conds&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="s">&#39;contrasts&#39;</span><span class="p">,</span> <span class="n">contrastgen</span><span class="p">,</span> <span class="s">&#39;contrast_file&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;task_id&#39;</span><span class="p">,</span> <span class="n">contrastgen</span><span class="p">,</span> <span class="s">&#39;task_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">contrastgen</span><span class="p">,</span> <span class="s">&#39;contrasts&#39;</span><span class="p">,</span> <span class="n">modelfit</span><span class="p">,</span> <span class="s">&#39;inputspec.contrasts&#39;</span><span class="p">)</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">preproc</span><span class="p">,</span> <span class="n">art</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;outputspec.motion_parameters&#39;</span><span class="p">,</span>
                             <span class="s">&#39;realignment_parameters&#39;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s">&#39;outputspec.realigned_files&#39;</span><span class="p">,</span>
                             <span class="s">&#39;realigned_files&#39;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s">&#39;outputspec.mask&#39;</span><span class="p">,</span> <span class="s">&#39;mask_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">preproc</span><span class="p">,</span> <span class="n">modelspec</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;outputspec.highpassed_files&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;functional_runs&#39;</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s">&#39;outputspec.motion_parameters&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;realignment_parameters&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">art</span><span class="p">,</span> <span class="n">modelspec</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;outlier_files&#39;</span><span class="p">,</span> <span class="s">&#39;outlier_files&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">modelspec</span><span class="p">,</span> <span class="n">modelfit</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;session_info&#39;</span><span class="p">,</span>
                                    <span class="s">&#39;inputspec.session_info&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">preproc</span><span class="p">,</span> <span class="n">modelfit</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;outputspec.highpassed_files&#39;</span><span class="p">,</span>
                                  <span class="s">&#39;inputspec.functional_data&#39;</span><span class="p">)])</span>
            <span class="p">])</span>
</pre></div>
</div>
<p>Reorder the copes so that now it combines across runs</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sort_copes</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="n">numelements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">outfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numelements</span><span class="p">):</span>
        <span class="n">outfiles</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">elements</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">outfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">outfiles</span>

<span class="k">def</span> <span class="nf">num_copes</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

<span class="n">pickfirst</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">preproc</span><span class="p">,</span> <span class="n">fixed_fx</span><span class="p">,</span> <span class="p">[((</span><span class="s">&#39;outputspec.mask&#39;</span><span class="p">,</span> <span class="n">pickfirst</span><span class="p">),</span>
                                  <span class="s">&#39;flameo.mask_file&#39;</span><span class="p">)]),</span>
            <span class="p">(</span><span class="n">modelfit</span><span class="p">,</span> <span class="n">fixed_fx</span><span class="p">,</span> <span class="p">[((</span><span class="s">&#39;outputspec.copes&#39;</span><span class="p">,</span> <span class="n">sort_copes</span><span class="p">),</span>
                                   <span class="s">&#39;inputspec.copes&#39;</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s">&#39;outputspec.dof_file&#39;</span><span class="p">,</span>
                                    <span class="s">&#39;inputspec.dof_files&#39;</span><span class="p">),</span>
                                   <span class="p">((</span><span class="s">&#39;outputspec.varcopes&#39;</span><span class="p">,</span>
                                     <span class="n">sort_copes</span><span class="p">),</span>
                                    <span class="s">&#39;inputspec.varcopes&#39;</span><span class="p">),</span>
                                   <span class="p">((</span><span class="s">&#39;outputspec.copes&#39;</span><span class="p">,</span> <span class="n">num_copes</span><span class="p">),</span>
                                    <span class="s">&#39;l2model.num_copes&#39;</span><span class="p">),</span>
                                   <span class="p">])</span>
            <span class="p">])</span>

<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">preproc</span><span class="p">,</span> <span class="s">&#39;outputspec.mean&#39;</span><span class="p">,</span> <span class="n">registration</span><span class="p">,</span> <span class="s">&#39;inputspec.mean_image&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="s">&#39;anat&#39;</span><span class="p">,</span> <span class="n">registration</span><span class="p">,</span> <span class="s">&#39;inputspec.anatomical_image&#39;</span><span class="p">)</span>
<span class="n">registration</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">target_image</span> <span class="o">=</span> <span class="n">fsl</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">standard_image</span><span class="p">(</span><span class="s">&#39;MNI152_T1_2mm.nii.gz&#39;</span><span class="p">)</span>
<span class="n">registration</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">target_image_brain</span> <span class="o">=</span> <span class="n">fsl</span><span class="o">.</span><span class="n">Info</span><span class="o">.</span><span class="n">standard_image</span><span class="p">(</span><span class="s">&#39;MNI152_T1_2mm_brain.nii.gz&#39;</span><span class="p">)</span>
<span class="n">registration</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">config_file</span> <span class="o">=</span> <span class="s">&#39;T1_2_MNI152_2mm&#39;</span>

<span class="k">def</span> <span class="nf">merge_files</span><span class="p">(</span><span class="n">copes</span><span class="p">,</span> <span class="n">varcopes</span><span class="p">,</span> <span class="n">zstats</span><span class="p">):</span>
    <span class="n">out_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">copes</span><span class="p">)</span>
    <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">copes</span><span class="p">))</span>
    <span class="n">out_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">varcopes</span><span class="p">)</span>
    <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varcopes</span><span class="p">))</span>
    <span class="n">out_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">zstats</span><span class="p">)</span>
    <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zstats</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out_files</span><span class="p">,</span> <span class="n">splits</span>

<span class="n">mergefunc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;copes&#39;</span><span class="p">,</span> <span class="s">&#39;varcopes&#39;</span><span class="p">,</span>
                                              <span class="s">&#39;zstats&#39;</span><span class="p">],</span>
                               <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;out_files&#39;</span><span class="p">,</span> <span class="s">&#39;splits&#39;</span><span class="p">],</span>
                               <span class="n">function</span><span class="o">=</span><span class="n">merge_files</span><span class="p">),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s">&#39;merge_files&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">fixed_fx</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s">&#39;outputspec&#39;</span><span class="p">),</span> <span class="n">mergefunc</span><span class="p">,</span>
                             <span class="p">[(</span><span class="s">&#39;copes&#39;</span><span class="p">,</span> <span class="s">&#39;copes&#39;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s">&#39;varcopes&#39;</span><span class="p">,</span> <span class="s">&#39;varcopes&#39;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s">&#39;zstats&#39;</span><span class="p">,</span> <span class="s">&#39;zstats&#39;</span><span class="p">),</span>
                              <span class="p">])])</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mergefunc</span><span class="p">,</span> <span class="s">&#39;out_files&#39;</span><span class="p">,</span> <span class="n">registration</span><span class="p">,</span> <span class="s">&#39;inputspec.source_files&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">split_files</span><span class="p">(</span><span class="n">in_files</span><span class="p">,</span> <span class="n">splits</span><span class="p">):</span>
    <span class="n">copes</span> <span class="o">=</span> <span class="n">in_files</span><span class="p">[:</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">varcopes</span> <span class="o">=</span> <span class="n">in_files</span><span class="p">[</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="n">zstats</span> <span class="o">=</span> <span class="n">in_files</span><span class="p">[(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]):]</span>
    <span class="k">return</span> <span class="n">copes</span><span class="p">,</span> <span class="n">varcopes</span><span class="p">,</span> <span class="n">zstats</span>

<span class="n">splitfunc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;in_files&#39;</span><span class="p">,</span> <span class="s">&#39;splits&#39;</span><span class="p">],</span>
                                 <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;copes&#39;</span><span class="p">,</span> <span class="s">&#39;varcopes&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;zstats&#39;</span><span class="p">],</span>
                                 <span class="n">function</span><span class="o">=</span><span class="n">split_files</span><span class="p">),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s">&#39;split_files&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mergefunc</span><span class="p">,</span> <span class="s">&#39;splits&#39;</span><span class="p">,</span> <span class="n">splitfunc</span><span class="p">,</span> <span class="s">&#39;splits&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">registration</span><span class="p">,</span> <span class="s">&#39;outputspec.transformed_files&#39;</span><span class="p">,</span>
           <span class="n">splitfunc</span><span class="p">,</span> <span class="s">&#39;in_files&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Connect to a datasink</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_subs</span><span class="p">(</span><span class="n">subject_id</span><span class="p">,</span> <span class="n">conds</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
    <span class="n">subs</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;_subject_id_</span><span class="si">%s</span><span class="s">_&#39;</span> <span class="o">%</span> <span class="n">subject_id</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)]</span>
    <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_model_id_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">model_id</span><span class="p">,</span> <span class="s">&#39;model</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span><span class="n">model_id</span><span class="p">))</span>
    <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;task_id_</span><span class="si">%d</span><span class="s">/&#39;</span> <span class="o">%</span> <span class="n">task_id</span><span class="p">,</span> <span class="s">&#39;/task</span><span class="si">%03d</span><span class="s">_&#39;</span> <span class="o">%</span> <span class="n">task_id</span><span class="p">))</span>
    <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;bold_dtype_mcf_mask_smooth_mask_gms_tempfilt_mean_warp&#39;</span><span class="p">,</span>
    <span class="s">&#39;mean&#39;</span><span class="p">))</span>
    <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;bold_dtype_mcf_mask_smooth_mask_gms_tempfilt_mean_flirt&#39;</span><span class="p">,</span>
    <span class="s">&#39;affine&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conds</span><span class="p">)):</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_flameo</span><span class="si">%d</span><span class="s">/cope1.&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s">&#39;cope</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_flameo</span><span class="si">%d</span><span class="s">/varcope1.&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s">&#39;varcope</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_flameo</span><span class="si">%d</span><span class="s">/zstat1.&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s">&#39;zstat</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_flameo</span><span class="si">%d</span><span class="s">/tstat1.&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s">&#39;tstat</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_flameo</span><span class="si">%d</span><span class="s">/res4d.&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s">&#39;res4d</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_warpall</span><span class="si">%d</span><span class="s">/cope1_warp.&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                     <span class="s">&#39;cope</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_warpall</span><span class="si">%d</span><span class="s">/varcope1_warp.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conds</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
                     <span class="s">&#39;varcope</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_warpall</span><span class="si">%d</span><span class="s">/zstat1_warp.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">conds</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
                     <span class="s">&#39;zstat</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_warpall</span><span class="si">%d</span><span class="s">/cope1_trans.&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                     <span class="s">&#39;cope</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_warpall</span><span class="si">%d</span><span class="s">/varcope1_trans.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conds</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
                     <span class="s">&#39;varcope</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;_warpall</span><span class="si">%d</span><span class="s">/zstat1_trans.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">conds</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
                     <span class="s">&#39;zstat</span><span class="si">%02d</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">subs</span>

<span class="n">subsgen</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">niu</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s">&#39;conds&#39;</span><span class="p">,</span>
                                            <span class="s">&#39;model_id&#39;</span><span class="p">,</span> <span class="s">&#39;task_id&#39;</span><span class="p">],</span>
                               <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;substitutions&#39;</span><span class="p">],</span>
                               <span class="n">function</span><span class="o">=</span><span class="n">get_subs</span><span class="p">),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s">&#39;subsgen&#39;</span><span class="p">)</span>

<span class="n">datasink</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">nio</span><span class="o">.</span><span class="n">DataSink</span><span class="p">(),</span>
                   <span class="n">name</span><span class="o">=</span><span class="s">&quot;datasink&quot;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="s">&#39;container&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subsgen</span><span class="p">,</span> <span class="s">&#39;subject_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;model_id&#39;</span><span class="p">,</span> <span class="n">subsgen</span><span class="p">,</span> <span class="s">&#39;model_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">infosource</span><span class="p">,</span> <span class="s">&#39;task_id&#39;</span><span class="p">,</span> <span class="n">subsgen</span><span class="p">,</span> <span class="s">&#39;task_id&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">contrastgen</span><span class="p">,</span> <span class="s">&#39;contrasts&#39;</span><span class="p">,</span> <span class="n">subsgen</span><span class="p">,</span> <span class="s">&#39;conds&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">subsgen</span><span class="p">,</span> <span class="s">&#39;substitutions&#39;</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="s">&#39;substitutions&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">fixed_fx</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s">&#39;outputspec&#39;</span><span class="p">),</span> <span class="n">datasink</span><span class="p">,</span>
                             <span class="p">[(</span><span class="s">&#39;res4d&#39;</span><span class="p">,</span> <span class="s">&#39;res4d&#39;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s">&#39;copes&#39;</span><span class="p">,</span> <span class="s">&#39;copes&#39;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s">&#39;varcopes&#39;</span><span class="p">,</span> <span class="s">&#39;varcopes&#39;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s">&#39;zstats&#39;</span><span class="p">,</span> <span class="s">&#39;zstats&#39;</span><span class="p">),</span>
                              <span class="p">(</span><span class="s">&#39;tstats&#39;</span><span class="p">,</span> <span class="s">&#39;tstats&#39;</span><span class="p">)])</span>
                             <span class="p">])</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">splitfunc</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span>
             <span class="p">[(</span><span class="s">&#39;copes&#39;</span><span class="p">,</span> <span class="s">&#39;copes.mni&#39;</span><span class="p">),</span>
              <span class="p">(</span><span class="s">&#39;varcopes&#39;</span><span class="p">,</span> <span class="s">&#39;varcopes.mni&#39;</span><span class="p">),</span>
              <span class="p">(</span><span class="s">&#39;zstats&#39;</span><span class="p">,</span> <span class="s">&#39;zstats.mni&#39;</span><span class="p">),</span>
              <span class="p">])])</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">registration</span><span class="p">,</span> <span class="s">&#39;outputspec.transformed_mean&#39;</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="s">&#39;mean.mni&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">registration</span><span class="p">,</span> <span class="s">&#39;outputspec.func2anat_transform&#39;</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="s">&#39;xfm.mean2anat&#39;</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">registration</span><span class="p">,</span> <span class="s">&#39;outputspec.anat2target_transform&#39;</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="s">&#39;xfm.anat2target&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Set processing parameters</p>
<dl class="docutils">
<dt>::</dt>
<dd><blockquote class="first">
<div><p>preproc.inputs.inputspec.fwhm = fwhm
gethighpass.inputs.hpcutoff = hpcutoff
modelspec.inputs.high_pass_filter_cutoff = hpcutoff
modelfit.inputs.inputspec.bases = {&#8216;dgamma&#8217;: {&#8216;derivs&#8217;: use_derivatives}}
modelfit.inputs.inputspec.model_serial_correlations = True
if version &lt; 507:</p>
<blockquote>
<div>modelfit.inputs.inputspec.film_threshold = 1000</div></blockquote>
<dl class="docutils">
<dt>else:</dt>
<dd>modelfit.inputs.inputspec.film_threshold = -1000</dd>
</dl>
<p>datasink.inputs.base_directory = output_dir
return wf</p>
</div></blockquote>
<dl class="last docutils">
<dt>if __name__ == &#8216;__main__&#8217;:</dt>
<dd><p class="first">import argparse
defstr = &#8216; (default %(default)s)&#8217;
parser = argparse.ArgumentParser(prog=&#8217;fmri_openfmri.py&#8217;,</p>
<blockquote>
<div>description=__doc__)</div></blockquote>
<p>parser.add_argument(&#8216;-d&#8217;, &#8216;&#8211;datasetdir&#8217;, required=True)
parser.add_argument(&#8216;-s&#8217;, &#8216;&#8211;subject&#8217;, default=[],</p>
<blockquote>
<div>nargs=&#8217;+&#8217;, type=str,
help=&#8221;Subject name (e.g. &#8216;sub001&#8217;)&#8221;)</div></blockquote>
<dl class="docutils">
<dt>parser.add_argument(&#8216;-m&#8217;, &#8216;&#8211;model&#8217;, default=1,</dt>
<dd>help=&#8221;Model index&#8221; + defstr)</dd>
<dt>parser.add_argument(&#8216;-x&#8217;, &#8216;&#8211;subjectprefix&#8217;, default=&#8217;sub*&#8217;,</dt>
<dd>help=&#8221;Subject prefix&#8221; + defstr)</dd>
<dt>parser.add_argument(&#8216;-t&#8217;, &#8216;&#8211;task&#8217;, default=1, #nargs=&#8217;+&#8217;,</dt>
<dd>type=int, help=&#8221;Task index&#8221; + defstr)</dd>
<dt>parser.add_argument(&#8216;&#8211;hpfilter&#8217;, default=120.,</dt>
<dd>type=float, help=&#8221;High pass filter cutoff (in secs)&#8221; + defstr)</dd>
<dt>parser.add_argument(&#8216;&#8211;fwhm&#8217;, default=6.,</dt>
<dd>type=float, help=&#8221;Spatial FWHM&#8221; + defstr)</dd>
<dt>parser.add_argument(&#8216;&#8211;derivatives&#8217;, action=&#8221;store_true&#8221;,</dt>
<dd>help=&#8221;Use derivatives&#8221; + defstr)</dd>
<dt>parser.add_argument(&#8220;-o&#8221;, &#8220;&#8211;output_dir&#8221;, dest=&#8221;outdir&#8221;,</dt>
<dd>help=&#8221;Output directory base&#8221;)</dd>
<dt>parser.add_argument(&#8220;-w&#8221;, &#8220;&#8211;work_dir&#8221;, dest=&#8221;work_dir&#8221;,</dt>
<dd>help=&#8221;Output directory base&#8221;)</dd>
<dt>parser.add_argument(&#8220;-p&#8221;, &#8220;&#8211;plugin&#8221;, dest=&#8221;plugin&#8221;,</dt>
<dd>default=&#8217;Linear&#8217;,
help=&#8221;Plugin to use&#8221;)</dd>
<dt>parser.add_argument(&#8220;&#8211;plugin_args&#8221;, dest=&#8221;plugin_args&#8221;,</dt>
<dd>help=&#8221;Plugin arguments&#8221;)</dd>
</dl>
<p>args = parser.parse_args()
outdir = args.outdir
work_dir = os.getcwd()
if args.work_dir:</p>
<blockquote>
<div>work_dir = os.path.abspath(args.work_dir)</div></blockquote>
<dl class="docutils">
<dt>if outdir:</dt>
<dd>outdir = os.path.abspath(outdir)</dd>
<dt>else:</dt>
<dd>outdir = os.path.join(work_dir, &#8216;output&#8217;)</dd>
<dt>outdir = os.path.join(outdir, &#8216;model%02d&#8217; % int(args.model),</dt>
<dd>&#8216;task%03d&#8217; % int(args.task))</dd>
</dl>
<p>derivatives = args.derivatives
if derivatives is None:</p>
<blockquote>
<div>derivatives = False</div></blockquote>
<dl class="docutils">
<dt>wf = analyze_openfmri_dataset(data_dir=os.path.abspath(args.datasetdir),</dt>
<dd>subject=args.subject,
model_id=int(args.model),
task_id=[int(args.task)],
subj_prefix=args.subjectprefix,
output_dir=outdir,
hpcutoff=args.hpfilter,
use_derivatives=derivatives,
fwhm=args.fwhm)</dd>
</dl>
<p>wf.base_dir = work_dir
if args.plugin_args:</p>
<blockquote>
<div>wf.run(args.plugin, plugin_args=eval(args.plugin_args))</div></blockquote>
<dl class="last docutils">
<dt>else:</dt>
<dd>wf.run(args.plugin)</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<div class="admonition-example-source-code admonition">
<p class="first admonition-title">Example source code</p>
<p class="last">You can download <a class="reference download internal" href="../../_downloads/fmri_ants_openfmri.py"><code class="xref download docutils literal"><span class="pre">the</span> <span class="pre">full</span> <span class="pre">source</span> <span class="pre">code</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">example</span></code></a>.
This same script is also included in the Nipype source distribution under the
<code class="file docutils literal"><span class="pre">examples</span></code> directory.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2009-14, Neuroimaging in Python team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
</div>

  </body>
</html>